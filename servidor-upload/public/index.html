<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Upload de Arquivos</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: #333; margin: 0; padding: 20px; min-height: 100vh;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .form-container {
      background: #fff; padding: 30px; border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 100%;
      max-width: 400px; margin-bottom: 20px;
    }
    h1, h2 { color: #fff; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    h2 { color: #333; text-shadow: none; margin-top: 0; }
    input[type="email"], input[type="password"], input[type="file"] {
      width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px;
      border: 1px solid #ddd; font-size: 1rem;
    }
    button {
      width: 100%; background-color: #2575fc; color: #fff; border: none; padding: 15px;
      font-size: 1.1rem; border-radius: 10px; cursor: pointer; font-weight: 600;
      transition: background-color 0.3s ease;
    }
    button:hover { background-color: #1859c6; }
    #status {
      min-height: 1.5em; text-align: center; font-weight: 600; color: #fff;
      text-shadow: 1px 1px 4px rgba(0,0,0,0.5); width: 100%; max-width: 450px;
    }
    #authToggle { color: #007bff; cursor: pointer; text-align: center; margin-top: 15px; }
    #authToggle:hover { text-decoration: underline; }
    #mainContent { display: none; width: 100%; max-width: 500px; }
    #fileList { list-style: none; padding: 0; background: #fff; border-radius: 12px; max-height: 300px; overflow-y: auto; }
    #fileList li { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; border-bottom: 1px solid #eee; }
    #fileList li:last-child { border-bottom: none; }
    .file-actions button { width: auto; font-size: 0.8rem; padding: 5px 10px; background-color: #ff5252; }
    .file-actions a { font-size: 0.8rem; margin-right: 10px; }
    #userInfo { color: white; font-weight: bold; text-align: center; margin-bottom: 20px; }
    #logoutButton { background-color: #6c757d; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Serviço de Backup</h1>

  <div id="authSection" class="form-container">
    <div id="loginForm">
      <h2>Login</h2>
      <input type="email" id="loginEmail" placeholder="E-mail" required />
      <input type="password" id="loginPassword" placeholder="Senha" required />
      <button onclick="handleLogin()">Entrar</button>
      <p id="authToggle" onclick="toggleAuthForms()">Não tem uma conta? Cadastre-se</p>
    </div>
    <div id="registerForm" style="display: none;">
      <h2>Cadastro</h2>
      <input type="email" id="registerEmail" placeholder="E-mail" required />
      <input type="password" id="registerPassword" placeholder="Senha" required />
      <button onclick="handleRegister()">Cadastrar</button>
      <p id="authToggle" onclick="toggleAuthForms()">Já tem uma conta? Faça login</p>
    </div>
  </div>
  <p id="status"></p>

  <div id="mainContent">
    <div id="userInfo"></div>
    <div class="form-container">
      <h2>Meus Arquivos</h2>
      <input type="file" id="fileInput" name="files" multiple required />
      <button onclick="handleUpload()">Enviar Arquivos</button>
      <ul id="fileList"></ul>
    </div>
    <button id="logoutButton" onclick="logout()">Sair</button>
  </div>

<script>
const statusEl = document.getElementById('status');
const authSection = document.getElementById('authSection');
const mainContent = document.getElementById('mainContent');
const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
const fileList = document.getElementById('fileList');
const userInfo = document.getElementById('userInfo');

let currentUser = null;

// --- LÓGICA DE UI ---
function toggleAuthForms() {
  const isLoginVisible = loginForm.style.display !== 'none';
  loginForm.style.display = isLoginVisible ? 'none' : 'block';
  registerForm.style.display = isLoginVisible ? 'block' : 'none';
}

function showMainContent(user) {
  currentUser = user;
  authSection.style.display = 'none';
  mainContent.style.display = 'block';
  statusEl.textContent = '';
  userInfo.textContent = `Logado como: ${currentUser.email}`;
  if(currentUser.role === 'master') {
      userInfo.textContent += ' (Admin)';
  }
  loadFiles();
}

function logout() {
  currentUser = null;
  authSection.style.display = 'block';
  mainContent.style.display = 'none';
  statusEl.textContent = 'Você saiu.';
}

// --- CHAMADAS À API ---
async function handleApiCall(url, options, successMessage) {
  statusEl.textContent = 'Processando...';
  try {
    const response = await fetch(url, options);
    const data = await response.json();
    if (!response.ok) throw new Error(data.message || 'Ocorreu um erro.');
    statusEl.textContent = successMessage || data.message;
    return data;
  } catch (err) {
    statusEl.textContent = `Erro: ${err.message}`;
    throw err;
  }
}

async function handleLogin() {
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  try {
    const data = await handleApiCall('/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });
    showMainContent(data.user);
  } catch (err) { /* erro já tratado em handleApiCall */ }
}

async function handleRegister() {
  const email = document.getElementById('registerEmail').value;
  const password = document.getElementById('registerPassword').value;
  try {
    await handleApiCall('/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    }, 'Cadastro realizado com sucesso! Faça o login.');
    toggleAuthForms(); // Volta para a tela de login
  } catch (err) { /* erro já tratado */ }
}

async function handleUpload() {
  const fileInput = document.getElementById('fileInput');
  if (fileInput.files.length === 0) {
    statusEl.textContent = 'Selecione pelo menos um arquivo.';
    return;
  }
  const formData = new FormData();
  for (const file of fileInput.files) {
    formData.append('files', file);
  }
  
  try {
    await fetch(`/upload?user=${currentUser.email}`, { method: 'POST', body: formData });
    statusEl.textContent = 'Arquivos enviados com sucesso!';
    fileInput.value = '';
    loadFiles();
  } catch (err) {
    statusEl.textContent = 'Erro no envio.';
  }
}

async function loadFiles() {
  fileList.innerHTML = '<li>Carregando...</li>';
  const res = await fetch(`/files?user=${currentUser.email}`);
  const files = await res.json();
  fileList.innerHTML = '';
  if (files.length === 0) {
    fileList.innerHTML = '<li>Nenhum arquivo encontrado.</li>';
    return;
  }
  files.forEach(file => {
    const li = document.createElement('li');
    const displayName = currentUser.role === 'master' ? `[${file.user}] ${file.name}` : file.name;
    li.innerHTML = `
      <span>${displayName}</span>
      <div class="file-actions">
        <a href="/download/${file.user}/${encodeURIComponent(file.name)}" target="_blank">Baixar</a>
        <button onclick="deleteFile('${file.user}', '${file.name}')">Deletar</button>
      </div>
    `;
    fileList.appendChild(li);
  });
}

async function deleteFile(user, filename) {
  if (confirm(`Deseja deletar o arquivo "${filename}"?`)) {
    await fetch(`/delete/${user}/${encodeURIComponent(filename)}`, { method: 'DELETE' });
    loadFiles();
  }
}
</script>
</body>
</html>
