<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meu Backup</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --google-blue: #1a73e8;
      --google-gray-border: #dadce0;
      --google-gray-background: #f8f9fa;
      --google-gray-text: #5f6368;
      --danger-red: #d93025;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--google-gray-background);
      color: #202124;
    }

    /* --- Container Central --- */
    .center-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .form-box {
      background-color: #fff;
      padding: 40px;
      border: 1px solid var(--google-gray-border);
      border-radius: 8px;
      width: 100%;
      max-width: 448px;
      text-align: center;
      margin-bottom: 16px;
    }
    .form-box h1 { font-size: 24px; font-weight: 400; margin-bottom: 8px; }
    .form-box p { color: var(--google-gray-text); margin-bottom: 24px; }
    .form-box input {
      width: 100%;
      padding: 13px 15px;
      margin-bottom: 15px;
      border-radius: 4px;
      border: 1px solid var(--google-gray-border);
      font-size: 1rem;
    }
    .form-box button {
      width: 100%; background-color: var(--google-blue); color: #fff; border: none;
      padding: 10px; font-size: 1rem; font-weight: 500; border-radius: 4px; cursor: pointer;
      transition: background-color 0.2s;
    }
    .form-box button:hover { background-color: #1b66c9; }
    #authToggle { color: var(--google-blue); cursor: pointer; font-weight: 500; margin-top: 15px; font-size: 0.9rem; }
    #status {
      min-height: 1.5em; text-align: center; font-weight: 500; color: var(--danger-red);
      width: 100%; max-width: 448px;
    }

    /* --- Layout Principal (Após Login) --- */
    #main-view { display: none; }
    .top-bar {
      background-color: #fff;
      padding: 12px 30px;
      border-bottom: 1px solid var(--google-gray-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
      z-index: 1000;
    }
    .top-bar h2 { font-size: 22px; font-weight: 400; }
    .profile-section { display: flex; align-items: center; gap: 16px; }
    #userInfo { color: var(--google-gray-text); font-size: 1rem; }
    #logoutButton {
      background-color: var(--danger-red); color: #fff;
      border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;
      font-weight: 500;
    }
    
    .content-area { padding: 100px 30px 30px; }
    #upload-section { margin-bottom: 30px; }

    /* Estilo da Tabela de Arquivos */
    .files-view {
        background-color: #fff;
        border: 1px solid var(--google-gray-border);
        border-radius: 8px;
        padding: 16px;
    }
    .files-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 8px 12px;
        border-bottom: 2px solid var(--google-gray-border);
        margin-bottom: 12px;
    }
    #delete-selected-btn {
        background-color: var(--danger-red);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        display: none; /* Inicia escondido */
    }
    #fileTable { width: 100%; border-collapse: collapse; }
    #fileTable th {
      text-align: left;
      padding: 12px 8px;
      font-weight: 500;
      color: var(--google-gray-text);
    }
    #fileTable td {
      padding: 14px 8px;
      border-bottom: 1px solid var(--google-gray-border);
      vertical-align: middle;
    }
    #fileTable tr:last-child td { border-bottom: none; }
    #fileTable tr:hover { background-color: var(--google-gray-background); }
    .file-name { display: flex; align-items: center; gap: 16px; font-weight: 500; }
    .file-icon { color: var(--google-blue); }
    .actions { white-space: nowrap; }
    .actions a, .actions button {
      background: none; border: none; cursor: pointer; color: var(--google-gray-text);
      padding: 8px; border-radius: 50%;
      display: inline-flex; align-items: center; justify-content: center;
      vertical-align: middle;
    }
    .actions a:hover, .actions button:hover { background-color: #e8e8e8; }
    .checkbox-col { width: 40px; }
  </style>
</head>
<body>

  <div id="authContainer" class="center-container">
    <div class="form-box">
      <div id="loginForm">
        <h1>Fazer login</h1>
        <p>Continue para seu backup</p>
        <input type="email" id="loginEmail" placeholder="E-mail" required />
        <input type="password" id="loginPassword" placeholder="Senha" required />
        <button onclick="handleLogin()">Entrar</button>
        <p id="authToggle" onclick="toggleAuthForms()">Criar conta</p>
      </div>
      <div id="registerForm" style="display: none;">
        <h1>Criar sua Conta</h1>
        <input type="email" id="registerEmail" placeholder="E-mail" required />
        <input type="password" id="registerPassword" placeholder="Senha" required />
        <button onclick="handleRegister()">Cadastrar</button>
        <p id="authToggle" onclick="toggleAuthForms()">Já tem uma conta? Faça login</p>
      </div>
    </div>
    <p id="status"></p>
  </div>

  <main id="main-view">
    <header class="top-bar">
        <h2>Meu Backup</h2>
        <div class="profile-section">
            <span id="userInfo"></span>
            <button id="logoutButton" onclick="logout()">Sair</button>
        </div>
    </header>

    <div class="content-area">
        <section id="upload-section" class="form-box">
            <h2>Fazer upload de arquivos</h2>
            <input type="file" id="fileInput" multiple required />
            <button onclick="handleUpload()">Enviar Arquivos</button>
        </section>

        <section class="files-view">
            <div class="files-header">
                <h3>Arquivos</h3>
                <button id="delete-selected-btn" onclick="deleteSelectedFiles()">Excluir Selecionados</button>
            </div>
            <table id="fileTable">
              <thead>
                <tr>
                  <th class="checkbox-col"><input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this.checked)"></th>
                  <th>Nome</th>
                  <th id="owner-col-header" style="display: none;">Proprietário</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="fileList"></tbody>
            </table>
        </section>
    </div>
  </main>

<script>
// --- Seletores de Elementos ---
const statusEl = document.getElementById('status');
const authContainer = document.getElementById('authContainer');
const mainView = document.getElementById('main-view');
const fileList = document.getElementById('fileList');
const userInfo = document.getElementById('userInfo');
const fileInput = document.getElementById('fileInput');
const deleteSelectedBtn = document.getElementById('delete-selected-btn');
const selectAllCheckbox = document.getElementById('select-all-checkbox');

let currentUser = null;

// --- ÍCONES SVG para Ações ---
const fileIconSvg = `<svg class="file-icon" focusable="false" viewBox="0 0 24 24" width="24" height="24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"></path></svg>`;
const previewIconSvg = `<svg focusable="false" viewBox="0 0 24 24" width="24" height="24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12c-2.48 0-4.5-2.02-4.5-4.5S9.52 7.5 12 7.5s4.5 2.02 4.5 4.5-2.02 4.5-4.5 4.5zm0-7c-1.38 0-2.5 1.12-2.5 2.5s1.12 2.5 2.5 2.5 2.5-1.12 2.5-2.5-1.12-2.5-2.5-2.5z"></path></svg>`;
const downloadIconSvg = `<svg focusable="false" viewBox="0 0 24 24" width="24" height="24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>`;
const deleteIconSvg = `<svg focusable="false" viewBox="0 0 24 24" width="24" height="24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>`;

// --- LÓGICA DE UI ---
function toggleAuthForms() {
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const isLoginVisible = loginForm.style.display !== 'none';
  loginForm.style.display = isLoginVisible ? 'none' : 'block';
  registerForm.style.display = isLoginVisible ? 'block' : 'none';
  statusEl.textContent = '';
}

function showMainContent(user) {
  currentUser = user;
  authContainer.style.display = 'none';
  mainView.style.display = 'block';
  userInfo.textContent = currentUser.email;

  const ownerHeader = document.getElementById('owner-col-header');
  ownerHeader.style.display = (currentUser.role === 'master') ? 'table-cell' : 'none';
  
  loadFiles();
}

function logout() {
  currentUser = null;
  authContainer.style.display = 'flex';
  mainView.style.display = 'none';
}

// --- CHAMADAS À API ---
async function handleApiCall(url, options) {
  statusEl.textContent = '';
  try {
    const response = await fetch(url, options);
    const data = await response.json();
    if (!response.ok) throw new Error(data.message || 'Ocorreu um erro.');
    return data;
  } catch (err) {
    statusEl.textContent = `Erro: ${err.message}`;
    throw err;
  }
}

async function handleLogin() {
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  try {
    const data = await handleApiCall('/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });
    showMainContent(data.user);
  } catch (err) {}
}

async function handleRegister() {
  const email = document.getElementById('registerEmail').value;
  const password = document.getElementById('registerPassword').value;
  try {
    const data = await handleApiCall('/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });
    alert(data.message);
    toggleAuthForms();
  } catch (err) {}
}

// --- LÓGICA DE SELEÇÃO E EXCLUSÃO ---
function updateDeleteButtonState() {
    const selectedCheckboxes = document.querySelectorAll('.file-checkbox:checked');
    deleteSelectedBtn.style.display = selectedCheckboxes.length > 0 ? 'block' : 'none';
}

function toggleSelectAll(checked) {
    document.querySelectorAll('.file-checkbox').forEach(checkbox => {
        checkbox.checked = checked;
    });
    updateDeleteButtonState();
}

async function deleteSelectedFiles() {
    const selectedFiles = [];
    document.querySelectorAll('.file-checkbox:checked').forEach(checkbox => {
        selectedFiles.push({
            user: checkbox.dataset.user,
            name: checkbox.dataset.name
        });
    });

    if (selectedFiles.length === 0) {
        alert('Nenhum arquivo selecionado.');
        return;
    }

    if (confirm(`Tem certeza que deseja deletar ${selectedFiles.length} arquivo(s)?`)) {
        try {
            const data = await handleApiCall('/delete-many', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: selectedFiles })
            });
            alert(data.message);
            loadFiles(); // Recarrega a lista
        } catch(err) {
            alert('Falha ao deletar arquivos.');
        }
    }
}

// --- FUNCIONALIDADES DE ARQUIVO ---
async function handleUpload() {
  if (fileInput.files.length === 0) {
    alert('Por favor, selecione pelo menos um arquivo.');
    return;
  }
  
  const formData = new FormData();
  for (const file of fileInput.files) {
    formData.append('files', file);
  }
  
  try {
    const res = await fetch(`/upload?user=${currentUser.email}`, { method: 'POST', body: formData });
    if (!res.ok) throw new Error(await res.text());
    alert('Arquivos enviados com sucesso!');
    fileInput.value = '';
    loadFiles();
  } catch (err) {
    alert('Erro no envio: ' + err.message);
  }
}

async function loadFiles() {
  fileList.innerHTML = '<tr><td colspan="4">Carregando...</td></tr>';
  updateDeleteButtonState();
  selectAllCheckbox.checked = false;
  try {
    const res = await fetch(`/files?user=${currentUser.email}`);
    const files = await res.json();
    fileList.innerHTML = '';
    
    if (files.length === 0) {
      fileList.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">Nenhum arquivo encontrado.</td></tr>';
      return;
    }
    
    files.forEach(file => {
      const tr = document.createElement('tr');
      const isMaster = currentUser.role === 'master';
      
      tr.innerHTML = `
        <td class="checkbox-col">
            <input type="checkbox" class="file-checkbox" data-user="${file.user}" data-name="${file.name}" onchange="updateDeleteButtonState()">
        </td>
        <td>
          <div class="file-name">
            ${fileIconSvg}
            <span>${file.name}</span>
          </div>
        </td>
        ${isMaster ? `<td>${file.user}</td>` : ''}
        <td class="actions">
          <a href="/preview/${file.user}/${encodeURIComponent(file.name)}" target="_blank" title="Visualizar">${previewIconSvg}</a>
          <a href="/download/${file.user}/${encodeURIComponent(file.name)}" title="Baixar">${downloadIconSvg}</a>
        </td>
      `;
      fileList.appendChild(tr);
    });
  } catch (err) {
    fileList.innerHTML = '<tr><td colspan="4">Erro ao carregar arquivos.</td></tr>';
  }
}
</script>
</body>
</html>
