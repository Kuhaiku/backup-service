<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>Meu Drive</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --google-blue: #1a73e8; --google-gray-border: #dadce0; --google-gray-background: #f8f9fa; --google-gray-text: #5f6368; --danger-red: #d93025; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--google-gray-background); color: #202124; }
        .center-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .form-box { background-color: #fff; padding: 40px; border: 1px solid var(--google-gray-border); border-radius: 8px; width: 100%; max-width: 448px; text-align: center; margin-bottom: 16px; }
        .form-box h1 { font-size: 24px; font-weight: 400; margin-bottom: 8px; }
        .form-box input { width: 100%; padding: 13px; margin-bottom: 15px; border-radius: 4px; border: 1px solid var(--google-gray-border); }
        .form-box button { width: 100%; background-color: var(--google-blue); color: #fff; border: none; padding: 10px; font-weight: 500; border-radius: 4px; cursor: pointer; }
        #status { min-height: 1.5em; font-weight: 500; color: var(--danger-red); }
        #main-view { display: none; }
        .top-bar { background-color: #fff; padding: 12px 30px; border-bottom: 1px solid var(--google-gray-border); display: flex; justify-content: space-between; align-items: center; position: fixed; width: 100%; top: 0; z-index: 1000; }
        .content-area { padding: 80px 30px 30px; }
        #breadcrumb { padding: 10px 0; font-size: 14px; }
        #breadcrumb a { color: var(--google-blue); text-decoration: none; cursor: pointer; }
        .files-view { background-color: #fff; border: 1px solid var(--google-gray-border); border-radius: 8px; padding: 16px; }
        .files-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; margin-bottom: 12px; border-bottom: 2px solid var(--google-gray-border); }
        .files-header button { background-color: var(--google-blue); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: 500; margin-left: 10px; }
        #delete-selected-btn, #move-selected-btn { display: none; }
        #delete-selected-btn { background-color: var(--danger-red); }
        #move-selected-btn { background-color: #5f6368; }
        #fileTable { width: 100%; border-collapse: collapse; }
        #fileTable th, #fileTable td { padding: 12px 8px; vertical-align: middle; text-align: left; }
        #fileTable td { border-bottom: 1px solid var(--google-gray-border); }
        .item-name { display: flex; align-items: center; gap: 16px; font-weight: 500; cursor: pointer; }
        .actions { white-space: nowrap; text-align: right; }
        .actions button, .actions a { background: none; border: none; cursor: pointer; padding: 8px; border-radius: 50%; display: inline-flex; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; }
    </style>
</head>
<body>
    <div id="authContainer" class="center-container"></div>
    <main id="main-view"></main>
    <div id="nameModal" class="modal"><div class="modal-content">
        <h3 id="modalTitle"></h3><input type="text" id="modalInput">
        <button id="modalConfirmBtn">Confirmar</button><button onclick="closeModal()">Cancelar</button>
    </div></div>
    <div id="moveModal" class="modal"><div class="modal-content">
        <h3>Mover Itens</h3><input type="text" id="moveInput" placeholder="Caminho/da/pasta (em branco para Início)">
        <button onclick="moveSelectedItems()">Mover</button><button onclick="closeModal()">Cancelar</button>
    </div></div>
<script>
    let currentUser = null, currentPath = '';
    const userFolderIcon = `<svg width="24" height="24" viewBox="0 0 24 24"><path fill="#5f6368" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>`;
    const folderIcon = `<svg width="24" height="24" viewBox="0 0 24 24"><path fill="#5f6368" d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"></path></svg>`;
    const fileIcon = `<svg width="24" height="24" viewBox="0 0 24 24"><path fill="#5f6368" d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"></path></svg>`;
    const previewIcon = `<svg width="24" height="24" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12c-2.48 0-4.5-2.02-4.5-4.5S9.52 7.5 12 7.5s4.5 2.02 4.5 4.5-2.02 4.5-4.5 4.5zm0-7c-1.38 0-2.5 1.12-2.5 2.5s1.12 2.5 2.5 2.5 2.5-1.12 2.5-2.5-1.12-2.5-2.5-2.5z"></path></svg>`;
    const downloadIcon = `<svg width="24" height="24" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>`;
    const renameIcon = `<svg width="24" height="24" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></svg>`;
    const deleteIcon = `<svg width="24" height="24" viewBox="0 0 24 24"><path fill="#d93025" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>`;
    
    function escapeHTML(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }
    
    async function apiCall(endpoint, body = {}) {
        const options = { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...body, user: currentUser, currentPath }) };
        const response = await fetch(endpoint, options);
        const data = await response.json();
        if (!response.ok) throw new Error(data.message || 'Ocorreu um erro.');
        return data;
    }

    // --- UI Rendering ---
    function renderAuthUI() { document.getElementById('authContainer').innerHTML = `<div class="form-box" id="loginForm"><h1>Fazer login</h1><input type="email" id="loginEmail" placeholder="E-mail" required /><input type="password" id="loginPassword" placeholder="Senha" required /><button onclick="handleLogin()">Entrar</button><p onclick="toggleAuthForms()" style="cursor:pointer;color:var(--google-blue);margin-top:15px;">Criar conta</p></div><div class="form-box" id="registerForm" style="display: none;"><h1>Criar Conta</h1><input type="email" id="registerEmail" placeholder="E-mail" required /><input type="password" id="registerPassword" placeholder="Senha" required /><button onclick="handleRegister()">Cadastrar</button><p onclick="toggleAuthForms()" style="cursor:pointer;color:var(--google-blue);margin-top:15px;">Já tem uma conta?</p></div><p id="status"></p>`; }
    function renderMainUI() { document.getElementById('main-view').innerHTML = `<header class="top-bar"><h2>Meu Drive</h2><div class="profile-section"><span id="userInfo"></span><button onclick="logout()">Sair</button></div></header><div class="content-area"><div id="breadcrumb"></div><section class="files-view"><div class="files-header"><div><input type="file" id="fileInput" multiple style="display:none" onchange="handleUpload(event)"><button onclick="document.getElementById('fileInput').click()">Upload</button><button onclick="showNewFolderModal()">+ Nova Pasta</button></div><div><button id="move-selected-btn" onclick="showMoveModal()">Mover</button><button id="delete-selected-btn" onclick="deleteSelectedItems()">Excluir</button></div></div><table id="fileTable"><thead><tr><th><input type="checkbox" onchange="toggleSelectAll(this.checked)"></th><th>Nome</th><th style="text-align:right">Ações</th></tr></thead><tbody id="fileList"></tbody></table></section></div>`; }

    // --- Auth Logic ---
    async function handleLogin() {
        try {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const response = await fetch('/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email, password }) });
            const data = await response.json();
            if (!response.ok) throw new Error(data.message);
            currentUser = data.user;
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('main-view').style.display = 'block';
            document.getElementById('userInfo').textContent = currentUser.email;
            loadFiles('');
        } catch (err) { document.getElementById('status').textContent = err.message; }
    }
    async function handleRegister() { try { const email = document.getElementById('registerEmail').value, password = document.getElementById('registerPassword').value; const response = await fetch('/register', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email, password }) }); const data = await response.json(); if (!response.ok) throw new Error(data.message); alert(data.message); toggleAuthForms(); } catch (err) { document.getElementById('status').textContent = err.message; } }
    function toggleAuthForms() { const l = document.getElementById('loginForm'), r = document.getElementById('registerForm'); l.style.display = l.style.display === 'none' ? 'block' : 'none'; r.style.display = r.style.display === 'none' ? 'block' : 'none'; }
    function logout() { location.reload(); }

    // --- File & Folder Logic ---
    async function loadFiles(path) {
        currentPath = path;
        try {
            const items = await apiCall('/files');
            const fileListBody = document.getElementById('fileList');
            fileListBody.innerHTML = '';
            items.sort((a, b) => (b.isFolder - a.isFolder) || a.name.localeCompare(b.name));

            if (items.length === 0) {
                fileListBody.innerHTML = `<tr><td colspan="3" style="text-align:center;padding:20px;">Esta pasta está vazia.</td></tr>`;
            } else {
                items.forEach(item => {
                    const tr = document.createElement('tr');
                    const fullItemPath = `${currentPath ? currentPath + '/' : ''}${item.name}`;
                    const isPreviewable = !item.isFolder && /\.(jpg|jpeg|png|pdf)$/i.test(item.name);
                    const safeName = escapeHTML(item.name);
                    const ownerEmail = (currentPath.split('/')[0] && currentUser.role === 'master') ? currentPath.split('/')[0] : currentUser.email;

                    tr.innerHTML = `
                        <td><input type="checkbox" class="item-checkbox" data-name="${safeName}"></td>
                        <td><div class="item-name" ${item.isFolder ? `onclick="loadFiles('${escapeHTML(fullItemPath)}')"` : `ondblclick="previewFile('${escapeHTML(fullItemPath)}')"`}>
                            ${item.isUserFolder ? userFolderIcon : (item.isFolder ? folderIcon : fileIcon)}
                            <span>${item.name}</span>
                        </div></td>
                        <td class="actions">
                            ${isPreviewable ? `<a href="/preview/${encodeURIComponent(ownerEmail)}/${encodeURIComponent(fullItemPath.substring(ownerEmail.length+1))}" target="_blank" title="Visualizar">${previewIcon}</a>` : ''}
                            ${!item.isFolder ? `<a href="/download/${encodeURIComponent(ownerEmail)}/${encodeURIComponent(fullItemPath.substring(ownerEmail.length+1))}" title="Baixar">${downloadIcon}</a>` : ''}
                            <button onclick="showRenameModal('${safeName}')" title="Renomear">${renameIcon}</button>
                            <button onclick="deleteSingleItem('${safeName}')" title="Excluir">${deleteIcon}</button>
                        </td>`;
                    fileListBody.appendChild(tr);
                });
            }
            renderBreadcrumb();
            updateActionButtonsState();
        } catch (error) { alert(`Erro: ${error.message}`); }
    }

    function renderBreadcrumb() {
        const breadcrumbEl = document.getElementById('breadcrumb');
        breadcrumbEl.innerHTML = '<a onclick="loadFiles(\'\')">Início</a>';
        let pathAccumulator = '';
        currentPath.split('/').filter(p => p).forEach(part => {
            pathAccumulator += (pathAccumulator ? '/' : '') + part;
            breadcrumbEl.innerHTML += `<span> / </span><a onclick="loadFiles('${escapeHTML(pathAccumulator)}')">${part}</a>`;
        });
    }
    
    async function handleUpload(event) {
        if (event.target.files.length === 0) return;
        const formData = new FormData();
        for (const file of event.target.files) formData.append('files', file);
        try {
            await fetch(`/upload?user=${currentUser.email}&path=${encodeURIComponent(currentPath)}`, { method: 'POST', body: formData });
            event.target.value = '';
            loadFiles(currentPath);
        } catch(err) { alert(`Erro no upload: ${err.message}`); }
    }

    function previewFile(path) {
        if (!/\.(jpg|jpeg|png|pdf)$/i.test(path)) return;
        const ownerEmail = (currentPath.split('/')[0] && currentUser.role === 'master') ? currentPath.split('/')[0] : currentUser.email;
        const relativePath = currentUser.role === 'master' ? path.substring(ownerEmail.length+1) : path;
        window.open(`/preview/${encodeURIComponent(ownerEmail)}/${encodeURIComponent(relativePath)}`, '_blank');
    }

    // --- Modals ---
    function showModal(modalId, title, value, onConfirm) {
        const modal = document.getElementById(modalId);
        if(title) modal.querySelector('h3').textContent = title;
        const input = modal.querySelector('input');
        input.value = value;
        modal.querySelector('button').onclick = onConfirm;
        modal.style.display = 'flex';
        input.focus();
    }
    function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
    function showNewFolderModal() { showModal('nameModal', 'Criar Nova Pasta', '', createFolder); }
    async function createFolder() {
        const folderName = document.getElementById('modalInput').value;
        if (folderName) await apiCall('/folders/create', { folderName }).then(() => loadFiles(currentPath)).catch(err => alert(err.message));
        closeModal();
    }
    function showRenameModal(oldName) { showModal('nameModal', 'Renomear Item', oldName, () => renameItem(oldName)); }
    async function renameItem(oldName) {
        const newName = document.getElementById('modalInput').value;
        if (newName && newName !== oldName) await apiCall('/items/rename', { oldName, newName }).then(() => loadFiles(currentPath)).catch(err => alert(err.message));
        closeModal();
    }
    function showMoveModal() { showModal('moveModal', null, currentPath, moveSelectedItems); }
    async function moveSelectedItems() {
        const destinationPath = document.getElementById('moveInput').value;
        const itemsToMove = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => cb.dataset.name);
        if (itemsToMove.length > 0) {
            await apiCall('/items/move', { itemsToMove, destinationPath })
                .then(data => { alert(data.message); loadFiles(currentPath); })
                .catch(err => alert(err.message));
        }
        closeModal();
    }
    
    // --- Selection and Bulk Actions ---
    function updateActionButtonsState() {
        const anyChecked = document.querySelector('.item-checkbox:checked');
        document.getElementById('delete-selected-btn').style.display = anyChecked ? 'inline-block' : 'none';
        document.getElementById('move-selected-btn').style.display = anyChecked ? 'inline-block' : 'none';
    }
    function toggleSelectAll(checked) {
        document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = checked);
        updateActionButtonsState();
    }
    document.body.addEventListener('change', e => { if (e.target.classList.contains('item-checkbox')) updateActionButtonsState(); });
    async function deleteItems(items) {
        if (items.length > 0 && confirm(`Deletar ${items.length} item(ns)? Esta ação não pode ser desfeita.`)) {
            await apiCall('/items/delete', { items }).then(() => loadFiles(currentPath)).catch(err => alert(err.message));
        }
    }
    function deleteSelectedItems() {
        const items = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => ({ name: cb.dataset.name }));
        deleteItems(items);
    }
    function deleteSingleItem(name) { deleteItems([{ name }]); }

    // --- Init ---
    renderAuthUI();
    renderMainUI();
</script>
</body>
</html>
